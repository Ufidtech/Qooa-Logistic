<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Reset Password - QOOA</title>
    <link rel="stylesheet" href="css/styles.css" />
  </head>
  <body style="display:flex;align-items:center;justify-content:center;min-height:100vh;background:#f3f4f6;">
    <div style="background:#fff;padding:28px;border-radius:12px;max-width:520px;width:100%;box-shadow:0 10px 20px rgba(0,0,0,0.08);">
      <h2 style="margin-bottom:8px;color:#1f2937;">Set a new password</h2>
      <p style="margin-bottom:16px;color:#6b7280;">Enter a new password for your account.</p>

      <form id="resetForm">
        <div style="margin-bottom:12px;">
          <label for="email" style="display:block;margin-bottom:6px;color:#374151;">Email address</label>
          <input id="email" type="email" required style="width:100%;padding:10px 12px;border-radius:6px;border:1px solid #e5e7eb;" />
        </div>

        <div style="margin-bottom:12px;">
          <label for="token" style="display:block;margin-bottom:6px;color:#374151;">Reset token</label>
          <input id="token" type="text" required style="width:100%;padding:10px 12px;border-radius:6px;border:1px solid #e5e7eb;" />
        </div>

        <div style="margin-bottom:12px;">
          <label for="newPassword" style="display:block;margin-bottom:6px;color:#374151;">New password</label>
          <input id="newPassword" type="password" required style="width:100%;padding:10px 12px;border-radius:6px;border:1px solid #e5e7eb;" />
        </div>

        <div style="display:flex;gap:8px;justify-content:flex-end;">
          <a href="login.html" style="align-self:center;color:#6b7280;text-decoration:none;">Back to login</a>
          <button type="submit" class="btn-primary" style="padding:10px 16px;background:#10b981;color:#fff;border:none;border-radius:8px;">Reset password</button>
        </div>
      </form>

      <div id="rp-msg" style="margin-top:12px;color:#059669;display:none;">Password reset successful. You can now login.</div>
      <div id="rp-err" style="margin-top:12px;color:#ef4444;display:none;"></div>
      <div id="rp-actions" style="margin-top:12px; display:none;">
        <p style="color:#6b7280;">If your reset link expired you can request a new one.</p>
        <div style="display:flex; gap:8px;">
          <input id="rp-email-input" type="email" placeholder="Enter email to resend" style="flex:1;padding:8px;border:1px solid #e5e7eb;border-radius:6px;" />
          <button id="rp-resend-btn" class="btn-primary" style="padding:8px 12px;">Request new link</button>
        </div>
        <div id="rp-resend-msg" style="margin-top:8px;color:#059669;display:none;"></div>
        <div id="rp-resend-err" style="margin-top:8px;color:#ef4444;display:none;"></div>
      </div>
    </div>

    <script>
      // Pre-fill token/email from query string if present
      function qs(name){
        const params = new URLSearchParams(window.location.search);
        return params.get(name) || '';
      }
      const emailFromQs = qs('email');
      const tokenFromQs = qs('token');
      const status = qs('status');
      const message = qs('message');

      document.getElementById('email').value = emailFromQs;
      document.getElementById('token').value = tokenFromQs;

      const backend = window.BACKEND_URL || 'http://localhost:3000';

      // If redirected from backend with a status, show friendly message
      if (status) {
        if (status === 'success') {
          document.getElementById('rp-msg').textContent = message || 'You may now set a new password.';
          document.getElementById('rp-msg').style.display = 'block';
          // show form so user can set password (token may already be prefilled)
        } else {
          // failed
          document.getElementById('rp-err').textContent = message || 'Invalid or expired reset link.';
          document.getElementById('rp-err').style.display = 'block';
          // Show actions to request a new link and hide the reset form to avoid futile attempts
          document.getElementById('resetForm').style.display = 'none';
          document.getElementById('rp-actions').style.display = 'block';
          // prefill resend email input if we have email from query
          if (emailFromQs) document.getElementById('rp-email-input').value = emailFromQs;
        }
      }

      // Resend handler for requesting a new reset link
      document.getElementById('rp-resend-btn').addEventListener('click', async function () {
        const email = document.getElementById('rp-email-input').value.trim();
        document.getElementById('rp-resend-msg').style.display = 'none';
        document.getElementById('rp-resend-err').style.display = 'none';
        if (!email) {
          document.getElementById('rp-resend-err').textContent = 'Please enter your email';
          document.getElementById('rp-resend-err').style.display = 'block';
          return;
        }
        try {
          const res = await fetch(backend + '/api/auth/forgot-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email })
          });
          const data = await res.json().catch(() => ({}));
          if (!res.ok) {
            document.getElementById('rp-resend-err').textContent = data.message || 'Unable to send reset email';
            document.getElementById('rp-resend-err').style.display = 'block';
            return;
          }
          document.getElementById('rp-resend-msg').textContent = data.message || 'Reset email sent. Please check your inbox.';
          document.getElementById('rp-resend-msg').style.display = 'block';
        } catch (err) {
          console.error('Resend request failed', err);
          document.getElementById('rp-resend-err').textContent = 'Network error';
          document.getElementById('rp-resend-err').style.display = 'block';
        }
      });

      document.getElementById('resetForm').addEventListener('submit', async function(e){
        e.preventDefault();
        document.getElementById('rp-msg').style.display = 'none';
        document.getElementById('rp-err').style.display = 'none';

        const payload = {
          token: document.getElementById('token').value,
          email: document.getElementById('email').value,
          newPassword: document.getElementById('newPassword').value
        };

        try{
          const res = await fetch(backend + '/api/auth/reset-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          const data = await res.json().catch(() => ({}));

          if(!res.ok){
            const msg = data?.message || 'Reset failed';
            document.getElementById('rp-err').textContent = msg;
            document.getElementById('rp-err').style.display = 'block';
            return;
          }

          document.getElementById('rp-msg').style.display = 'block';
          // Optionally redirect to login after a short delay
          setTimeout(() => { window.location.href = 'login.html'; }, 1800);
        }catch(err){
          console.error(err);
          document.getElementById('rp-err').textContent = 'Network error';
          document.getElementById('rp-err').style.display = 'block';
        }
      });
    </script>
  </body>
</html>